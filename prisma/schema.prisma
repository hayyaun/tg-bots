// Prisma schema file
// Documentation: https://pris.ly/d/prisma-schema
//
// ⚠️ IMPORTANT: When making schema changes:
// 1. Update this schema file
// 2. Create migration file manually: prisma/migrations/YYYYMMDDHHMMSS_description/migration.sql
// 3. Follow existing migration patterns (see AI_CONTEXT.md for details)
// 4. DO NOT run migrations locally - user handles database operations on production server

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 BigInt    @id @default(autoincrement()) @db.BigInt
  telegram_id        BigInt?   @unique @db.BigInt
  google_id          String?   @unique @db.VarChar(255)
  email              String?   @db.VarChar(255)
  username           String?   @db.VarChar(255)
  display_name       String?   @db.VarChar(100)
  biography          String?   @db.Text
  birth_date         DateTime? @db.Date
  age                Int?
  gender             String?   @db.VarChar(20)
  looking_for_gender String?   @db.VarChar(20)
  archetype_result   String?   @db.VarChar(50)
  mbti_result        String?   @db.VarChar(10)
  leftright_result   String?   @db.VarChar(20)
  politicalcompass_result String? @db.VarChar(20)
  enneagram_result   String?   @db.VarChar(10)
  bigfive_result     String?   @db.Text
  profile_image      String?
  mood               String?   @db.VarChar(10)
  interests          String[]  @default([]) // Note: GIN index exists via migration (see 20251217135532_add_matching_indexes)
  location           String?   @db.VarChar(50)
  language           String?   @db.VarChar(10)
  completion_score   Int       @default(0)
  last_online        DateTime?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @default(now()) @updatedAt

  // Relations
  likesGiven    Like[]     @relation("UserLikes")
  likesReceived Like[]     @relation("LikedByUser")
  ignoredGiven  Ignored[]  @relation("UserIgnores")
  ignoredReceived Ignored[] @relation("IgnoredByUser")
  reportsGiven  Report[]   @relation("Reporter")
  reportsReceived Report[] @relation("ReportedUser")
  bansGiven    Ban[]      @relation("Banner")
  bansReceived Ban[]       @relation("BannedUser")

  @@index([telegram_id])
  @@index([google_id])
  @@index([gender])
  @@index([looking_for_gender])
  @@index([completion_score])
  @@index([birth_date])
  @@index([age])
  // Composite indexes for efficient match finding queries
  @@index([gender, completion_score, birth_date])
  @@index([completion_score, birth_date])
  @@index([gender, completion_score, age])
  @@index([completion_score, age])
  @@map("users")
}

model Like {
  id           BigInt   @id @default(autoincrement()) @db.BigInt
  user_id      BigInt   @db.BigInt
  liked_user_id BigInt  @db.BigInt
  created_at   DateTime @default(now())

  user      User @relation("UserLikes", fields: [user_id], references: [id], onDelete: Cascade)
  likedUser User @relation("LikedByUser", fields: [liked_user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, liked_user_id])
  @@index([user_id])
  @@index([liked_user_id])
  @@map("likes")
}

model Ignored {
  id            BigInt   @id @default(autoincrement()) @db.BigInt
  user_id       BigInt   @db.BigInt
  ignored_user_id BigInt @db.BigInt
  created_at    DateTime @default(now())

  user        User @relation("UserIgnores", fields: [user_id], references: [id], onDelete: Cascade)
  ignoredUser User @relation("IgnoredByUser", fields: [ignored_user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, ignored_user_id])
  @@index([user_id])
  @@index([ignored_user_id])
  @@map("ignored")
}

model Report {
  id              BigInt   @id @default(autoincrement()) @db.BigInt
  reporter_id     BigInt   @db.BigInt
  reported_user_id BigInt  @db.BigInt
  reason          String?  @db.Text
  resolved        Boolean  @default(false)
  created_at      DateTime @default(now())

  reporter    User @relation("Reporter", fields: [reporter_id], references: [id], onDelete: Cascade)
  reportedUser User @relation("ReportedUser", fields: [reported_user_id], references: [id], onDelete: Cascade)

  @@index([reporter_id])
  @@index([reported_user_id])
  @@index([resolved])
  @@map("reports")
}

model Ban {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  banned_user_id BigInt   @db.BigInt
  banner_id     BigInt    @db.BigInt
  banned_until  DateTime? @db.Timestamp(3)
  reason        String?   @db.Text
  created_at    DateTime  @default(now())

  bannedUser User @relation("BannedUser", fields: [banned_user_id], references: [id], onDelete: Cascade)
  banner     User @relation("Banner", fields: [banner_id], references: [id], onDelete: Cascade)

  @@index([banned_user_id])
  @@index([banner_id])
  @@index([banned_until])
  @@map("bans")
}
